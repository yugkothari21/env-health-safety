<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Env Health & Safety ‚Äî Dashboard</title>
<link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

<header>
  <h1>Env Health & Safety Dashboard</h1>
  <div>
    <button id="themeToggle" aria-label="Toggle theme">üåó</button>
    <a href="/signup">Profile</a>
    <a href="/logout">Logout</a>
  </div>
</header>

<!-- CONTROLS -->
<div class="controls">
  <label>City <input id="city" value="Pune"></label>
  <button id="btnGet">Use GPS</button>
  <button id="btnManual">Manual</button>
</div>

<div id="status" class="status" aria-live="polite">Idle</div>

<!-- ALERT -->
<div id="alertBox" role="alertdialog" aria-modal="true" tabindex="-1" style="display:none">
  <p id="alertMsg"></p>
  <button onclick="closeAlert()">OK</button>
</div>

<!-- RESULTS -->
<div id="results" hidden>

<!-- ENVIRONMENT -->
<section class="card">
  <h2>üåç Environment</h2>
  <p>Temperature: <b><span id="tempVal"></span> ¬∞C</b></p>
  <p>Humidity: <b><span id="humVal"></span> %</b></p>
  <p>Pressure: <b><span id="presVal"></span> hPa</b></p>
</section>

<!-- HEAT -->
<section class="card">
  <h2>üå° Heat Stress</h2>
  <p>Heat Index: <b><span id="heatIndexVal"></span> ¬∞C</b></p>
  <p>Status: <span id="heatStatus" class="badge"></span></p>
  <p id="heatMsg"></p>
  <canvas id="heatChart" width="320" height="120"></canvas>
</section>

<!-- OXYGEN -->
<section class="card">
  <h2>üèî Altitude & Oxygen</h2>
  <p>Altitude: <b><span id="altitudeVal"></span> m</b></p>
  <p>Oxygen: <b><span id="oxygenVal"></span> %</b></p>
  <p>Status: <span id="oxygenStatus" class="badge"></span></p>
  <p>Personal Min Oxygen: <b><span id="minOxygenVal"></span> %</b></p>
  <p>Safe Altitude: <b><span id="safeAltVal"></span> m</b></p>
  <canvas id="oxygenChart" width="320" height="120"></canvas>
</section>

<!-- LIVE SOUND -->
<section class="card">
  <h2>üéô Live Sound Monitoring</h2>

  <p>Live Noise Level: <b><span id="liveDb">--</span> dB</b></p>
  <p>Safe Exposure Time: <b><span id="safeTime">--</span></b></p>
  <p>Safe Distance: <b><span id="safeDistance">--</span></b></p>

  <canvas id="spectrum" width="320" height="80"></canvas>

  <p id="noiseMsg" aria-live="assertive"></p>

  <button id="startMic">Start Monitoring</button>
  <button id="stopMic" disabled>Stop</button>
  <button id="calibrateMic">Calibrate Ambient Noise</button>
</section>

<!-- RISK -->
<section class="card">
  <h2>‚ö† Overall Risk</h2>
  <div class="risk-meter"><div id="riskFill"></div></div>
  <p id="riskLabel"></p>
</section>

</div>

<script>
/* ========== THEME ========== */
themeToggle.onclick = () =>
  document.documentElement.classList.toggle("light");

/* ========== ALERT + SPEECH ========== */
function speak(text){
  if (!window.speechSynthesis) return;
  const msg = new SpeechSynthesisUtterance(text);
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}
function showAlert(msg){
  alertMsg.textContent = msg;
  alertBox.style.display = "block";
  speak(msg);
}
function closeAlert(){
  alertBox.style.display = "none";
}

/* ========== BADGE ========== */
function setBadge(el, status){
  el.textContent = status || "Unknown";
  el.className = "badge";
  if(!status) return;
  const s = status.toLowerCase();
  if(s.includes("safe")) el.classList.add("safe");
  else if(s.includes("mild") || s.includes("caution")) el.classList.add("caution");
  else el.classList.add("danger");
}

/* ========== CHART ========== */
function drawChart(id,data,color){
  const c=document.getElementById(id),ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.strokeStyle=color; ctx.beginPath();
  data.forEach((v,i)=>ctx.lineTo(i*(c.width/data.length),c.height-v));
  ctx.stroke();
}

/* ========== HISTORY ========== */
function saveHistory(k,v){
  let a=JSON.parse(localStorage.getItem(k)||"[]");
  a.push(v); if(a.length>20) a.shift();
  localStorage.setItem(k,JSON.stringify(a)); return a;
}

/* ========== API ========== */
async function callApi(params){
  status.textContent="Fetching data...";
  const r=await fetch("/api/metrics?"+new URLSearchParams(params));
  const j=await r.json();
  results.hidden=false;

  tempVal.textContent=j.temperature;
  humVal.textContent=j.humidity;
  presVal.textContent=j.pressure;

  heatIndexVal.textContent=j.heat_index;
  heatMsg.textContent=j.comfort_message;
  setBadge(heatStatus,j.heat_level);

  altitudeVal.textContent=j.current_altitude_m;
  oxygenVal.textContent=j.oxygen_percent;
  minOxygenVal.textContent=j.personal_min_oxygen;
  safeAltVal.textContent=j.max_safe_altitude_m;
  setBadge(oxygenStatus,j.oxygen_status);

  drawChart("heatChart",saveHistory("h",j.heat_index),"#f87171");
  drawChart("oxygenChart",saveHistory("o",j.oxygen_percent),"#34d399");

  let risk=0;
  if(j.heat_level==="Danger") risk+=40;
  if(j.oxygen_status==="High Risk") risk+=40;

  riskFill.style.width=risk+"%";
  riskLabel.textContent=risk<30?"Low Risk":risk<60?"Moderate Risk":"High Risk ‚Äì Take precautions";
  if(risk>=60) showAlert("High environmental risk detected");

  status.textContent="Updated";
}

/* ========== BUTTONS ========== */
btnGet.onclick=()=>navigator.geolocation.getCurrentPosition(p=>{
  callApi({lat:p.coords.latitude,lon:p.coords.longitude});
});
btnManual.onclick=()=>callApi({city:city.value});

/* ========== LIVE MIC (FIXED) ========== */
let audioContext, analyser, dataArray, freqArray, anim;
let calibrationOffset = 0;

function calcDb(buf){
  let s=0;
  for(let i=0;i<buf.length;i++){
    let v=(buf[i]-128)/128; s+=v*v;
  }
  return Math.max(
    30,
    Math.round(20*Math.log10(Math.sqrt(s/buf.length))+100) - calibrationOffset
  );
}

function drawSpectrum(){
  const c=document.getElementById("spectrum");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  analyser.getByteFrequencyData(freqArray);
  const bw=c.width/freqArray.length;
  freqArray.forEach((v,i)=>{
    ctx.fillStyle="#38bdf8";
    ctx.fillRect(i*bw,c.height,v/2,bw-1);
  });
}

async function startMicHandler(){
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  audioContext=new AudioContext();
  analyser=audioContext.createAnalyser();
  analyser.fftSize=256;

  audioContext.createMediaStreamSource(stream).connect(analyser);
  dataArray=new Uint8Array(analyser.fftSize);
  freqArray=new Uint8Array(analyser.frequencyBinCount);

  startMicBtn.disabled=true;
  stopMicBtn.disabled=false;
  speak("Sound monitoring started");
  updateMic();
}

function stopMicHandler(){
  cancelAnimationFrame(anim);
  audioContext?.close();
  startMicBtn.disabled=false;
  stopMicBtn.disabled=true;
  speak("Sound monitoring stopped");
}

function calibrate(){
  calibrationOffset = liveDb.textContent !== "--"
    ? parseInt(liveDb.textContent) - 40
    : 0;
  showAlert("Calibration complete");
}

function updateMic(){
  analyser.getByteTimeDomainData(dataArray);
  const db=calcDb(dataArray);

  liveDb.textContent=db;
  safeTime.textContent=db<=85?"8 hours":(8/Math.pow(2,(db-85)/3)).toFixed(2)+" hours";
  safeDistance.textContent=db<=70?"Safe":"~"+Math.pow(10,(db-70)/20).toFixed(1)+" m";
  noiseMsg.textContent=db>=85?"‚ö† Dangerous noise level!":"Sound level is safe.";

  drawSpectrum();

  if(db>=90){
    showAlert("Dangerous noise detected. Monitoring stopped.");
    stopMicHandler();
    return;
  }

  anim=requestAnimationFrame(updateMic);
}

/* BUTTON HOOKS (FIXED) */
const startMicBtn=document.getElementById("startMic");
const stopMicBtn=document.getElementById("stopMic");
const calibrateBtn=document.getElementById("calibrateMic");

startMicBtn.onclick=startMicHandler;
stopMicBtn.onclick=stopMicHandler;
calibrateBtn.onclick=calibrate;
</script>

</div>
</body>
</html>
