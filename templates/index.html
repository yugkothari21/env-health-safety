<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Env Health & Safety â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

<header>
  <h1>Env Health & Safety Dashboard</h1>
  <div>
    <button id="themeToggle" aria-label="Toggle theme">ğŸŒ—</button>
    <a href="/signup">Profile</a>
    <a href="/logout">Logout</a>
  </div>
</header>

<!-- CONTROLS -->
<div class="controls">
  <label>City <input id="city" value="Pune"></label>

  <label>
    Persona
    <select id="personaSelect">
      <option value="general">General User</option>
      <option value="student">Student</option>
      <option value="worker">Factory Worker</option>
      <option value="traveler">Traveler / Trekker</option>
      <option value="office">Office Worker</option>
    </select>
  </label>

  <button id="btnGet">Use GPS</button>
  <button id="btnManual">Manual</button>
  <button id="btnPdf" style="background:#8b5cf6; margin-left:auto;">ğŸ“„ Download Report</button>
</div>

<div id="status" class="status">System Idle</div>

<!-- ALERT -->
<div id="alertBox" style="display:none">
  <p id="alertMsg"></p>
  <button id="alertOk">OK</button>
</div>

<!-- SAFETY TOOLS -->
<div id="safety-tools" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;margin-bottom:1.5rem;">

<section class="card">
  <h2>ğŸ“¢ Report Hazard</h2>
  <input id="hazType" placeholder="Hazard type">
  <input id="hazDesc" placeholder="Description">
  <button id="hazBtn">Submit</button>
</section>

<section class="card">
  <h2>ğŸ¤– Safety AI Bot</h2>
  <div id="chatLog" style="height:120px;overflow-y:auto;background:#eee;padding:10px;border-radius:8px;font-size:0.9rem;"></div>
  <div style="display:flex;gap:10px;margin-top:10px;">
    <input id="chatInput" placeholder="Ask a safety question..." style="flex:1;">
    <button id="chatSend">Send</button>
  </div>
</section>

</div>

<!-- RESULTS -->
<div id="results" hidden>

<section class="card">
  <h2>ğŸŒ Environment</h2>
  <p>Temperature: <b><span id="tempVal"></span> Â°C</b></p>
  <p>Humidity: <b><span id="humVal"></span> %</b></p>
  <p>Pressure: <b><span id="presVal"></span> hPa</b></p>
</section>

<section class="card">
  <h2>ğŸŒ¡ Heat Stress</h2>
  <p>Heat Index: <b><span id="heatIndexVal"></span> Â°C</b></p>
  <p>Status: <span id="heatStatus" class="badge"></span></p>
  <p id="heatMsg"></p>
  <canvas id="heatChart" width="320" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ” Altitude & Oxygen</h2>
  <p>Altitude: <b><span id="altitudeVal"></span> m</b></p>
  <p>Oxygen: <b><span id="oxygenVal"></span> %</b></p>
  <p>Status: <span id="oxygenStatus" class="badge"></span></p>
  <p>Personal Min Oxygen: <b><span id="minOxygenVal"></span> %</b></p>
  <canvas id="oxygenChart" width="320" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ™ Live Sound Monitoring</h2>
  <p>Noise Level: <b><span id="liveDb">--</span> dB</b></p>
  <p>Safe Exposure Time: <b><span id="safeTime">--</span></b></p>
  <canvas id="spectrum" width="320" height="80"></canvas>
  <p id="noiseMsg"></p>
  <button id="startMic">Start</button>
  <button id="stopMic" disabled>Stop</button>
</section>

<section class="card">
  <h2>ğŸ§  Why am I seeing this?</h2>
  <ul id="explainList"></ul>
</section>

<section class="card">
  <h2>ğŸ“Š Personalized Health Insights</h2>
  <ul id="insightsList"></ul>
</section>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const btnGet=$("btnGet"), btnManual=$("btnManual"), btnPdf=$("btnPdf");
const startMic=$("startMic"), stopMic=$("stopMic");
const liveDb=$("liveDb"), safeTime=$("safeTime"), spectrum=$("spectrum");
const explainList=$("explainList"), insightsList=$("insightsList");
const personaSelect=$("personaSelect");

/* ===== THEME ===== */
$("themeToggle").onclick=()=>document.documentElement.classList.toggle("light");

/* ===== PERSONA ===== */
let persona=localStorage.getItem("persona")||"general";
personaSelect.value=persona;
personaSelect.onchange=()=>localStorage.setItem("persona",personaSelect.value);

/* ===== ALERT ===== */
$("alertOk").onclick=()=>$("alertBox").style.display="none";
function showAlert(m){ $("alertMsg").textContent=m; $("alertBox").style.display="block"; }

/* ===== API ===== */
async function callApi(p){
  $("status").textContent="Fetching data...";
  const r=await fetch("/api/metrics?"+new URLSearchParams(p));
  const j=await r.json();
  $("results").hidden=false;

  $("tempVal").textContent=j.temperature;
  $("humVal").textContent=j.humidity;
  $("presVal").textContent=j.pressure;
  $("heatIndexVal").textContent=j.heat_index;
  $("heatMsg").textContent=j.comfort_message;
  $("altitudeVal").textContent=j.current_altitude_m;
  $("oxygenVal").textContent=j.oxygen_percent;
  $("minOxygenVal").textContent=j.personal_min_oxygen;

  updateExplainability(j);
  updateInsights(j);

  $("status").textContent="Updated";
}

/* ===== BUTTONS ===== */
btnGet.onclick=()=>navigator.geolocation.getCurrentPosition(p=>callApi({lat:p.coords.latitude,lon:p.coords.longitude}));
btnManual.onclick=()=>callApi({city:$("city").value});
btnPdf.onclick=()=>location.href="/api/download_report";

/* ===== HAZARD ===== */
$("hazBtn").onclick=async()=>{
  const r=await fetch("/api/report_hazard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:$("hazType").value,description:$("hazDesc").value})});
  const j=await r.json(); showAlert(j.message);
};

/* ===== CHAT ===== */
$("chatSend").onclick=async()=>{
  if(!$("chatInput").value.trim())return;
  $("chatLog").innerHTML+=`<div><b>You:</b> ${$("chatInput").value}</div>`;
  const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:$("chatInput").value})});
  const j=await r.json();
  $("chatLog").innerHTML+=`<div><b>Bot:</b> ${j.reply}</div>`;
  $("chatInput").value="";
};

/* ===== SOUND ===== */
let ctx,analyser,data,anim;
startMic.onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({audio:true});
  ctx=new AudioContext();
  analyser=ctx.createAnalyser();
  ctx.createMediaStreamSource(s).connect(analyser);
  data=new Uint8Array(analyser.fftSize);
  startMic.disabled=true; stopMic.disabled=false;
  loop();
};
stopMic.onclick=()=>{cancelAnimationFrame(anim);ctx.close();startMic.disabled=false;stopMic.disabled=true;}
function loop(){
  analyser.getByteTimeDomainData(data);
  let sum=0;data.forEach(v=>sum+=(v-128)**2);
  const db=Math.round(20*Math.log10(Math.sqrt(sum/data.length))+100);
  liveDb.textContent=db;
  safeTime.textContent=db<85?"Safe":"Limit exposure";
  anim=requestAnimationFrame(loop);
}

/* ===== EXPLAINABILITY ===== */
function updateExplainability(j){
  explainList.innerHTML="";
  if(j.heat_level?.toLowerCase().includes("danger"))
    explainList.innerHTML+="<li>High heat stress detected.</li>";
  if(j.oxygen_percent<=19)
    explainList.innerHTML+="<li>Low oxygen at current altitude.</li>";
  if(!explainList.innerHTML)
    explainList.innerHTML="<li>All parameters within safe limits.</li>";
}

/* ===== INSIGHTS ===== */
function updateInsights(j){
  insightsList.innerHTML="";
  if(persona==="worker" && liveDb.textContent>=80)
    insightsList.innerHTML+="<li>Workers should use hearing protection.</li>";
  if(persona==="traveler" && j.oxygen_percent<=19)
    insightsList.innerHTML+="<li>Travelers may face altitude sickness.</li>";
  if(!insightsList.innerHTML)
    insightsList.innerHTML="<li>No concerning trends detected.</li>";
}

});
</script>

</div>
</body>
</html>
