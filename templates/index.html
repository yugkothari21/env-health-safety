<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Env Health & Safety â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

<header>
  <h1>Env Health & Safety Dashboard</h1>
  <div>
    <button id="themeToggle">ðŸŒ—</button>
    <a href="/signup">Profile</a>
    <a href="/logout">Logout</a>
  </div>
</header>

<div class="controls">
  <label>City <input id="city" value="Pune"></label>

  <label>
    Persona
    <select id="personaSelect">
      <option value="general">General User</option>
      <option value="student">Student</option>
      <option value="worker">Factory Worker</option>
      <option value="traveler">Traveler</option>
      <option value="office">Office Worker</option>
    </select>
  </label>

  <button id="btnGet">Use GPS</button>
  <button id="btnManual">Manual</button>
  <button id="btnPdf">ðŸ“„ Report</button>
</div>

<div id="status">System Idle</div>

<div id="alertBox" style="display:none">
  <p id="alertMsg"></p>
  <button onclick="closeAlert()">OK</button>
</div>

<div id="safety-tools">

<section class="card">
  <h2>ðŸ“¢ Report Hazard</h2>
  <input id="hazType" placeholder="Type">
  <input id="hazDesc" placeholder="Description">
  <button id="hazBtn">Submit</button>
</section>

<section class="card">
  <h2>ðŸ¤– Safety AI Bot</h2>
  <div id="chatLog"></div>
  <input id="chatInput" placeholder="Askâ€¦">
  <button id="chatSend">Send</button>
</section>

</div>

<div id="results" hidden>

<section class="card">
  <h2>ðŸŽ™ Live Sound Monitoring</h2>
  <p>Noise: <span id="liveDb">--</span> dB</p>
  <canvas id="spectrum" width="300" height="80"></canvas>
  <button id="startMic">Start</button>
  <button id="stopMic" disabled>Stop</button>
</section>

<section class="card">
  <h2>ðŸ§  Explainability</h2>
  <ul id="explainList"></ul>
</section>

<section class="card">
  <h2>ðŸ“Š Insights</h2>
  <ul id="insightsList"></ul>
</section>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

/* ===== DOM ===== */
const btnGet = document.getElementById("btnGet");
const btnManual = document.getElementById("btnManual");
const btnPdf = document.getElementById("btnPdf");
const liveDb = document.getElementById("liveDb");
const explainList = document.getElementById("explainList");
const insightsList = document.getElementById("insightsList");
const personaSelect = document.getElementById("personaSelect");

/* ===== PERSONA ===== */
let persona = localStorage.getItem("persona") || "general";
personaSelect.value = persona;
personaSelect.onchange=()=>localStorage.setItem("persona",personaSelect.value);

/* ===== ALERT ===== */
function showAlert(m){ alertMsg.textContent=m; alertBox.style.display="block"; }
window.closeAlert=()=>alertBox.style.display="none";

/* ===== API ===== */
async function callApi(p){
  const r=await fetch("/api/metrics?"+new URLSearchParams(p));
  const j=await r.json();
  results.hidden=false;
  updateExplainability();
  updateInsights();
}

/* ===== BUTTONS ===== */
btnGet.onclick=()=>navigator.geolocation.getCurrentPosition(p=>callApi({lat:p.coords.latitude,lon:p.coords.longitude}));
btnManual.onclick=()=>callApi({city:city.value});
btnPdf.onclick=()=>location.href="/api/download_report";

/* ===== HAZARD ===== */
hazBtn.onclick=async()=>{
  const r=await fetch("/api/report_hazard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:hazType.value,description:hazDesc.value})});
  const j=await r.json(); showAlert(j.message);
};

/* ===== CHAT ===== */
chatSend.onclick=async()=>{
  if(!chatInput.value) return;
  chatLog.innerHTML+=`<div>You: ${chatInput.value}</div>`;
  const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:chatInput.value})});
  const j=await r.json();
  chatLog.innerHTML+=`<div>Bot: ${j.reply}</div>`;
  chatInput.value="";
};

/* ===== SOUND ===== */
let ctx,analyser,data,anim;
startMic.onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({audio:true});
  ctx=new AudioContext(); analyser=ctx.createAnalyser();
  ctx.createMediaStreamSource(s).connect(analyser);
  data=new Uint8Array(analyser.fftSize);
  startMic.disabled=true; stopMic.disabled=false;
  loop();
};
stopMic.onclick=()=>{
  cancelAnimationFrame(anim); ctx.close();
  startMic.disabled=false; stopMic.disabled=true;
};
function loop(){
  analyser.getByteTimeDomainData(data);
  let sum=0; data.forEach(v=>sum+=(v-128)**2);
  liveDb.textContent=Math.round(20*Math.log10(Math.sqrt(sum/data.length))+100);
  anim=requestAnimationFrame(loop);
}

/* ===== EXPLAIN + INSIGHT ===== */
function updateExplainability(){
  explainList.innerHTML="<li>System running safely.</li>";
}
function updateInsights(){
  insightsList.innerHTML="<li>No issues detected.</li>";
}

});
</script>

</div>
</body>
</html>
