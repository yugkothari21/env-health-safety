<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Env Health & Safety â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

<header>
  <h1>Env Health & Safety Dashboard</h1>
  <div>
    <button id="themeToggle">ğŸŒ—</button>
    <a href="/signup">Profile</a>
    <a href="/logout">Logout</a>
  </div>
</header>

<!-- CONTROLS -->
<div class="controls">
  <label>City <input id="city" value="Pune"></label>

  <label>
    Persona
    <select id="personaSelect">
      <option value="general">General User</option>
      <option value="student">Student</option>
      <option value="worker">Factory Worker</option>
      <option value="traveler">Traveler / Trekker</option>
      <option value="office">Office Worker</option>
    </select>
  </label>

  <button id="btnGet">Use GPS</button>
  <button id="btnManual">Manual</button>
  <button id="btnPdf" style="background:#8b5cf6;margin-left:auto;">ğŸ“„ Download Report</button>
</div>

<div id="status" class="status">System Idle</div>

<!-- ALERT -->
<div id="alertBox" style="display:none">
  <p id="alertMsg"></p>
  <button id="alertOk">OK</button>
</div>

<!-- AREA RISK ALERT -->
<div id="areaRiskBanner" style="display:none;background:#dc2626;color:white;padding:10px;margin-bottom:15px;border-radius:8px;">
  âš  A hazard has been reported in your area. Please exercise extreme caution.
</div>

<!-- SAFETY TOOLS -->
<div id="safety-tools" class="grid">

<section class="card">
  <h2>ğŸ“¢ Report Hazard</h2>
  <input id="hazType" placeholder="Hazard Type (Fire, Gas, Chemical)">
  <input id="hazDesc" placeholder="Description">
  <button id="hazBtn">Submit</button>
</section>

<section class="card">
  <h2>ğŸ“ Your Reported Hazard</h2>
  <div id="userHazards">
    <p style="color:#6b7280;font-size:0.9rem;">No hazard reported yet.</p>
  </div>
</section>

<section class="card">
  <h2>ğŸ¤– Safety AI Bot</h2>
  <div id="chatLog" class="chat-box"></div>
  <div class="chat-input">
    <input id="chatInput" placeholder="Ask a safety question...">
    <button id="chatSend">Send</button>
  </div>
</section>

</div>

<!-- RESULTS -->
<div id="results" hidden>

<section class="card">
  <h2>ğŸŒ Environment</h2>
  <p>Temperature: <b><span id="tempVal"></span> Â°C</b></p>
  <p>Humidity: <b><span id="humVal"></span> %</b></p>
  <p>Pressure: <b><span id="presVal"></span> hPa</b></p>
</section>

<section class="card">
  <h2>ğŸŒ¡ Heat Stress</h2>
  <p>Heat Index: <b><span id="heatIndexVal"></span> Â°C</b></p>
  <p>Status: <span id="heatStatus" class="badge"></span></p>
  <p id="heatMsg"></p>
  <canvas id="heatChart" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ” Altitude & Oxygen</h2>
  <p>Altitude: <b><span id="altitudeVal"></span> m</b></p>
  <p>Oxygen: <b><span id="oxygenVal"></span> %</b></p>
  <p>Status: <span id="oxygenStatus" class="badge"></span></p>
  <p>Personal Min Oxygen: <b><span id="minOxygenVal"></span> %</b></p>
  <canvas id="oxygenChart" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ™ Live Sound Monitoring</h2>
  <p>Noise Level: <b><span id="liveDb">--</span> dB</b></p>
  <p>Safe Exposure Time: <b><span id="safeTime">--</span></b></p>
  <canvas id="spectrum" height="80"></canvas>
  <p id="noiseMsg"></p>
  <button id="startMic">Start</button>
  <button id="stopMic" disabled>Stop</button>
</section>

<section class="card">
  <h2>ğŸ§  Explainability</h2>
  <ul id="explainList"></ul>
</section>

<section class="card">
  <h2>ğŸ“Š Personalized Health Insights</h2>
  <ul id="insightsList"></ul>
</section>

<section class="card" id="nearbyHazardsCard" style="display:none;">
  <h2 style="color:#dc2626;">ğŸš¨ Hazards Near You</h2>
  <div id="nearbyHazardsList"></div>
</section>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const $ = id => document.getElementById(id);
const status = $("status");

/* THEME */
$("themeToggle").onclick=()=>document.documentElement.classList.toggle("light");

/* PERSONA */
let persona = localStorage.getItem("persona") || "general";
$("personaSelect").value = persona;
$("personaSelect").onchange = e => {
  persona = e.target.value;
  localStorage.setItem("persona", persona);
};

/* ALERT */
$("alertOk").onclick=()=>$("alertBox").style.display="none";
function alertUser(msg){
  $("alertMsg").textContent = msg;
  $("alertBox").style.display = "block";
}

/* API */
async function callApi(params){
  status.textContent = "Fetching data...";
  const r = await fetch("/api/metrics?" + new URLSearchParams(params));
  const j = await r.json();
  $("results").hidden = false;

  $("tempVal").textContent = j.temperature;
  $("humVal").textContent = j.humidity;
  $("presVal").textContent = j.pressure;
  $("heatIndexVal").textContent = j.heat_index;
  $("heatMsg").textContent = j.comfort_message;
  $("heatStatus").textContent = j.heat_level;
  $("altitudeVal").textContent = j.current_altitude_m;
  $("oxygenVal").textContent = j.oxygen_percent;
  $("minOxygenVal").textContent = j.personal_min_oxygen;
  $("oxygenStatus").textContent = j.oxygen_status;

  drawSimpleChart("heatChart", j.heat_index, 60);
  drawSimpleChart("oxygenChart", j.oxygen_percent, 25);

  updateExplainability(j);
  updateInsights(j);

  $("areaRiskBanner").style.display = j.area_risk === "HIGH" ? "block" : "none";

  if(j.nearby_hazards?.length){
    $("nearbyHazardsCard").style.display="block";
    $("nearbyHazardsList").innerHTML = j.nearby_hazards.map(h=>`
      <div><b>${h.type}</b> â€” ${h.description}<br>
      <small>ğŸ“ ${h.location||"Unknown"} | âš  ${h.severity}</small></div>
    `).join("");
  }

  status.textContent = "Updated";
}

/* BUTTONS */
$("btnGet").onclick=()=>navigator.geolocation.getCurrentPosition(p=>callApi({lat:p.coords.latitude,lon:p.coords.longitude}));
$("btnManual").onclick=()=>callApi({city:$("city").value});
$("btnPdf").onclick=()=>location.href="/api/download_report";

/* HAZARD */
$("hazBtn").onclick=()=>navigator.geolocation.getCurrentPosition(pos=>{
  fetch("/api/report_hazard",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      type:$("hazType").value,
      description:$("hazDesc").value,
      location:$("city").value,
      lat:pos.coords.latitude,
      lon:pos.coords.longitude
    })
  }).then(r=>r.json()).then(j=>{
    $("userHazards").innerHTML=`<b>${j.report.type}</b> â€” ${j.report.description}`;
    alertUser(j.message);
  });
});

/* CHAT */
$("chatSend").onclick=async()=>{
  const msg=$("chatInput").value;
  if(!msg) return;
  $("chatLog").innerHTML+=`<div><b>You:</b> ${msg}</div>`;
  const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
  const j=await r.json();
  $("chatLog").innerHTML+=`<div><b>Bot:</b> ${j.reply}</div>`;
  $("chatInput").value="";
};

/* ===== UTILITIES ===== */
function drawSimpleChart(id,val,max){
  const c=$(id),ctx=c.getContext("2d");
  c.width=c.parentElement.clientWidth-20;
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle="#60a5fa";
  ctx.fillRect(0,c.height-(val/max)*c.height,c.width,(val/max)*c.height);
}

function updateExplainability(j){
  const el=$("explainList"); el.innerHTML="";
  if(j.heat_index>=40) el.innerHTML+="<li>Heat index is dangerously high.</li>";
  if(j.oxygen_percent<=19) el.innerHTML+="<li>Low oxygen due to altitude.</li>";
  if(!el.innerHTML) el.innerHTML="<li>All conditions are safe.</li>";
}

function updateInsights(j){
  const el=$("insightsList"); el.innerHTML="";
  if(persona==="worker" && j.noise_status==="DANGEROUS") el.innerHTML+="<li>Use hearing protection.</li>";
  if(persona==="traveler" && j.oxygen_percent<=19) el.innerHTML+="<li>Risk of altitude sickness.</li>";
  if(!el.innerHTML) el.innerHTML="<li>No health risks detected.</li>";
}

/* SOUND */
let audioCtx,analyser,data,anim;
$("startMic").onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  audioCtx=new AudioContext();
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  audioCtx.createMediaStreamSource(stream).connect(analyser);
  data=new Uint8Array(analyser.fftSize);
  $("startMic").disabled=true;
  $("stopMic").disabled=false;
  soundLoop();
};
$("stopMic").onclick=()=>{
  cancelAnimationFrame(anim);
  audioCtx.close();
  $("startMic").disabled=false;
  $("stopMic").disabled=true;
};
function soundLoop(){
  analyser.getByteTimeDomainData(data);
  let sum=0;
  data.forEach(v=>sum+=(v-128)**2);
  const db=Math.round(20*Math.log10(Math.sqrt(sum/data.length))+100);
  $("liveDb").textContent=db;
  $("safeTime").textContent=db<85?"Safe":"Limit Exposure";
  $("noiseMsg").textContent=db>=90?"âš  Dangerous noise!":"";
  anim=requestAnimationFrame(soundLoop);
}

});
</script>

</div>
</body>
</html>
