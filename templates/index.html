<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Env Health & Safety â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

<header>
  <h1>Env Health & Safety Dashboard</h1>
  <div>
    <button id="themeToggle" aria-label="Toggle theme">ğŸŒ—</button>
    <a href="/signup">Profile</a>
    <a href="/logout">Logout</a>
  </div>
</header>

<div class="controls">
  <label>City <input id="city" value="Pune"></label>

  <label>
    Persona
    <select id="personaSelect">
      <option value="general">General User</option>
      <option value="student">Student</option>
      <option value="worker">Factory Worker</option>
      <option value="traveler">Traveler / Trekker</option>
      <option value="office">Office Worker</option>
    </select>
  </label>

  <button id="btnGet">Use GPS</button>
  <button id="btnManual">Manual</button>
  <button id="btnPdf" style="background-color:#8b5cf6; margin-left:auto;">ğŸ“„ Download Report</button>
</div>

<div id="status" class="status" aria-live="polite">System Idle</div>

<div id="alertBox" role="alertdialog" aria-modal="true" tabindex="-1" style="display:none">
  <p id="alertMsg"></p>
  <button onclick="closeAlert()">OK</button>
</div>

<div id="safety-tools" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1.5rem; margin-bottom:1.5rem;">

<section class="card">
  <h2 style="color:#ef4444;">ğŸ“¢ Report Hazard</h2>
  <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
    <input id="hazType" placeholder="Hazard Type">
    <input id="hazDesc" placeholder="Description">
    <button onclick="submitHazard()" style="background-color:#ef4444; color:white;">Submit</button>
  </div>
</section>

<section class="card">
  <h2 style="color:#10b981;">ğŸ¤– Safety AI Bot</h2>
  <div id="chatLog" style="height:120px; overflow-y:auto; background:#eee; padding:10px; border-radius:8px;">
    <i>Ask about safetyâ€¦</i>
  </div>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input id="chatInput" placeholder="Ask a question..." style="flex:1;">
    <button onclick="askBot()" style="background-color:#10b981; color:white;">Send</button>
  </div>
</section>

</div>

<div id="results" hidden>

<section class="card">
  <h2>ğŸŒ Environment</h2>
  <p>Temperature: <b><span id="tempVal"></span> Â°C</b></p>
  <p>Humidity: <b><span id="humVal"></span> %</b></p>
  <p>Pressure: <b><span id="presVal"></span> hPa</b></p>
</section>

<section class="card">
  <h2>ğŸŒ¡ Heat Stress</h2>
  <p>Heat Index: <b><span id="heatIndexVal"></span> Â°C</b></p>
  <p>Status: <span id="heatStatus" class="badge"></span></p>
  <p id="heatMsg"></p>
  <canvas id="heatChart" width="320" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ” Altitude & Oxygen</h2>
  <p>Altitude: <b><span id="altitudeVal"></span> m</b></p>
  <p>Oxygen: <b><span id="oxygenVal"></span> %</b></p>
  <p>Status: <span id="oxygenStatus" class="badge"></span></p>
  <p>Min Oxygen: <b><span id="minOxygenVal"></span> %</b></p>
  <canvas id="oxygenChart" width="320" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ™ Live Sound Monitoring</h2>
  <p>Noise Level: <b><span id="liveDb">--</span> dB</b></p>
  <p>Safe Time: <b><span id="safeTime">--</span></b></p>
  <canvas id="spectrum" width="320" height="80"></canvas>
  <p id="noiseMsg"></p>
  <button id="startMic">Start</button>
  <button id="stopMic" disabled>Stop</button>
</section>

<section class="card">
  <h2>ğŸ§  Why am I seeing this?</h2>
  <ul id="explainList"></ul>
</section>

<section class="card">
  <h2>ğŸ“Š Personalized Health Insights</h2>
  <ul id="insightsList"></ul>
</section>

</div>

<script>
/* ===== DOM REFERENCES (CRITICAL FIX) ===== */
const btnGet = document.getElementById("btnGet");
const btnManual = document.getElementById("btnManual");
const btnPdf = document.getElementById("btnPdf");
const liveDb = document.getElementById("liveDb");
const explainList = document.getElementById("explainList");
const insightsList = document.getElementById("insightsList");
const personaSelect = document.getElementById("personaSelect");

/* ===== PERSONA MODE ===== */
let currentPersona = localStorage.getItem("persona") || "general";
personaSelect.value = currentPersona;
personaSelect.onchange = () => {
  currentPersona = personaSelect.value;
  localStorage.setItem("persona", currentPersona);
};

/* ===== THEME ===== */
themeToggle.onclick = () => document.documentElement.classList.toggle("light");

/* ===== API ===== */
async function callApi(params){
  status.textContent="Fetching data...";
  const r = await fetch("/api/metrics?" + new URLSearchParams(params));
  const j = await r.json();
  results.hidden = false;

  tempVal.textContent=j.temperature;
  humVal.textContent=j.humidity;
  presVal.textContent=j.pressure;
  heatIndexVal.textContent=j.heat_index;
  heatMsg.textContent=j.comfort_message;
  altitudeVal.textContent=j.current_altitude_m;
  oxygenVal.textContent=j.oxygen_percent;
  minOxygenVal.textContent=j.personal_min_oxygen;

  updateExplainability(parseInt(liveDb.textContent)||0,j.oxygen_percent,j.heat_level);
  updateInsights(parseInt(liveDb.textContent)||0,j.oxygen_percent,j.heat_index);

  status.textContent="Updated";
}

/* ===== BUTTONS ===== */
btnGet.onclick=()=>navigator.geolocation.getCurrentPosition(p=>callApi({lat:p.coords.latitude,lon:p.coords.longitude}));
btnManual.onclick=()=>callApi({city:city.value});
btnPdf.onclick=()=>window.location.href="/api/download_report";

/* ===== EXPLAINABILITY ===== */
function updateExplainability(noise,oxygen,heat){
  explainList.innerHTML="";
  if(noise>=80 && currentPersona==="worker") explainList.innerHTML+="<li>High noise risk for workers.</li>";
  if(oxygen<=19 && currentPersona==="traveler") explainList.innerHTML+="<li>Low oxygen at altitude.</li>";
  if(!explainList.innerHTML) explainList.innerHTML="<li>All conditions safe.</li>";
}

/* ===== INSIGHTS ===== */
function updateInsights(noise,oxygen,heat){
  insightsList.innerHTML="";
  if(noise>=80) insightsList.innerHTML+="<li>Repeated noise exposure detected.</li>";
  if(oxygen<=19) insightsList.innerHTML+="<li>Oxygen drops at higher altitude.</li>";
  if(!insightsList.innerHTML) insightsList.innerHTML="<li>No issues detected.</li>";
}
</script>

</div>
</body>
</html>
