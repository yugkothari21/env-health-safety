<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Env Health & Safety â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

<header>
  <h1>Env Health & Safety Dashboard</h1>
  <div>
    <button id="themeToggle">ğŸŒ—</button>
    <a href="/signup">Profile</a>
    <a href="/logout">Logout</a>
  </div>
</header>

<!-- CONTROLS -->
<div class="controls">
  <label>City <input id="city" value="Pune"></label>

  <label>
    Persona
    <select id="personaSelect">
      <option value="general">General User</option>
      <option value="student">Student</option>
      <option value="worker">Factory Worker</option>
      <option value="traveler">Traveler / Trekker</option>
      <option value="office">Office Worker</option>
    </select>
  </label>

  <button id="btnGet">Use GPS</button>
  <button id="btnManual">Manual</button>
  <button id="btnPdf" style="background:#8b5cf6;margin-left:auto;">ğŸ“„ Download Report</button>
</div>

<div id="status" class="status">System Idle</div>

<!-- ALERT -->
<div id="alertBox" style="display:none">
  <p id="alertMsg"></p>
  <button id="alertOk">OK</button>
</div>

<!-- AREA RISK ALERT -->
<div id="areaRiskBanner" style="display:none; background:#dc2626; color:white; padding:10px; margin-bottom:15px; border-radius:8px;">
  âš  A hazard or emergency has been reported in your area. Please exercise extreme caution.
</div>

<!-- SAFETY TOOLS -->
<div id="safety-tools" class="grid">

<section class="card">
  <h2>ğŸ“¢ Report Hazard</h2>
  <input id="hazType" placeholder="Hazard Type (Fire, Gas, Chemical)">
  <input id="hazDesc" placeholder="Description">
  <button id="hazBtn">Submit</button>
</section>

<section class="card">
  <h2>ğŸ“ Your Reported Hazard</h2>
  <div id="userHazards">
    <p style="color:#6b7280;font-size:0.9rem;">No hazard reported yet.</p>
  </div>
</section>

<section class="card">
  <h2>ğŸ¤– Safety AI Bot</h2>
  <div id="chatLog" class="chat-box"></div>
  <div class="chat-input">
    <input id="chatInput" placeholder="Ask a safety question...">
    <button id="chatSend">Send</button>
  </div>
</section>

</div>

<!-- RESULTS -->
<div id="results" hidden>

<section class="card">
  <h2>ğŸŒ Environment</h2>
  <p>Temperature: <b><span id="tempVal"></span> Â°C</b></p>
  <p>Humidity: <b><span id="humVal"></span> %</b></p>
  <p>Pressure: <b><span id="presVal"></span> hPa</b></p>
</section>

<section class="card">
  <h2>ğŸŒ¡ Heat Stress</h2>
  <p>Heat Index: <b><span id="heatIndexVal"></span> Â°C</b></p>
  <p>Status: <span id="heatStatus" class="badge"></span></p>
  <p id="heatMsg"></p>
  <canvas id="heatChart" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ” Altitude & Oxygen</h2>
  <p>Altitude: <b><span id="altitudeVal"></span> m</b></p>
  <p>Oxygen: <b><span id="oxygenVal"></span> %</b></p>
  <p>Status: <span id="oxygenStatus" class="badge"></span></p>
  <p>Personal Min Oxygen: <b><span id="minOxygenVal"></span> %</b></p>
  <canvas id="oxygenChart" height="120"></canvas>
</section>

<section class="card">
  <h2>ğŸ™ Live Sound Monitoring</h2>
  <p>Noise Level: <b><span id="liveDb">--</span> dB</b></p>
  <p>Safe Exposure Time: <b><span id="safeTime">--</span></b></p>
  <canvas id="spectrum" height="80"></canvas>
  <p id="noiseMsg"></p>
  <button id="startMic">Start</button>
  <button id="stopMic" disabled>Stop</button>
</section>

<section class="card">
  <h2>ğŸ§  Explainability</h2>
  <ul id="explainList"></ul>
</section>

<section class="card">
  <h2>ğŸ“Š Personalized Health Insights</h2>
  <ul id="insightsList"></ul>
</section>

<section class="card" id="nearbyHazardsCard" style="display:none;">
  <h2 style="color:#dc2626;">ğŸš¨ Hazards Near You</h2>
  <div id="nearbyHazardsList"></div>
</section>

<!-- ğŸ†˜ SOS PANEL (NEW, SAFE ADDITION) -->
<section class="card" style="border:2px solid #dc2626;">
  <h2 style="color:#dc2626;">ğŸ†˜ Emergency SOS</h2>
  <p style="font-size:0.9rem;color:#6b7280;">
    Use this only in real emergencies. Your live location will be shared.
  </p>
  <button id="sosBtn" style="
    background:#dc2626;
    color:white;
    font-size:1.2rem;
    padding:12px;
    width:100%;
    border:none;
    border-radius:8px;
  ">
    ğŸš¨ SEND SOS
  </button>
  <p id="sosStatus" style="margin-top:8px;font-size:0.9rem;"></p>
</section>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const $ = id => document.getElementById(id);

/* ALERT */
$("alertOk").onclick=()=>$("alertBox").style.display="none";
function alertUser(msg){
  $("alertMsg").textContent = msg;
  $("alertBox").style.display = "block";
}

/* SOS LOGIC â€” NEW */
$("sosBtn").onclick = () => {
  if(!confirm("This will send an emergency SOS with your live location. Continue?")) return;

  navigator.geolocation.getCurrentPosition(pos=>{
    fetch("/api/sos",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        lat: pos.coords.latitude,
        lon: pos.coords.longitude,
        location: $("city").value
      })
    })
    .then(r=>r.json())
    .then(j=>{
      $("sosStatus").textContent = "ğŸš¨ SOS sent successfully. Help is on the way.";
      $("areaRiskBanner").style.display = "block";
    })
    .catch(()=>{
      $("sosStatus").textContent = "âŒ Failed to send SOS.";
    });
  });
};

});
</script>

</div>
</body>
</html>
